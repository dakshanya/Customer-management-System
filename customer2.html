<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SalesCRM - Customers</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/customer2.css') }}">
</head>
<body class="bg-gray-50 font-sans">
    <div class="flex h-screen overflow-hidden">
        <!-- Navigation Bar -->
        <div class="sidebar-container">
            <div class="sidebar">
                <!-- Logo/Brand Section -->
                <div class="sidebar-header">
                    <div class="brand">
                        <i class="fas fa-chart-line brand-icon"></i>
                        <span class="brand-text">SalesCRM</span>
                    </div>
                </div>
                
                <!-- Navigation Links -->
                <div class="sidebar-content">
                    <nav class="navigation">
                        <a href="{{ url_for('dashboard') }}" class="nav-link">
                            <i class="fas fa-tachometer-alt nav-icon"></i>
                            Dashboard
                        </a>
                        <a href="customer.html" class="nav-link nav-link-active">
                            <i class="fas fa-users nav-icon"></i>
                            Customers
                        </a>
                        <a href="emp.html" class="nav-link">
                            <i class="fas fa-user-tie nav-icon"></i>
                            Employees
                        </a>
                        <a href="tasks.html" class="nav-link">
                            <i class="fas fa-tasks nav-icon"></i>
                            Tasks
                        </a>
                        <a href="history.html" class="nav-link">
                            <i class="fas fa-chart-pie nav-icon"></i>
                            Reports
                        </a>
                        <a href="notification.html" class="nav-link">
                            <i class="fas fa-bell nav-icon"></i>
                            Notifications
                        </a>
                        <a href="settings.html" class="nav-link">
                            <i class="fas fa-cog nav-icon"></i>
                            Settings
                        </a>
                    </nav>
                </div>
                
                <!-- User Profile Section -->
                <div class="sidebar-footer">
                    <div class="user-profile">
                        <img class="user-avatar" src="https://randomuser.me/api/portraits/men/32.jpg" alt="User profile">
                        <div class="user-info">
                            <p class="user-name">Admin User</p>
                            <p class="user-role">Admin</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex flex-col flex-1 overflow-hidden">
            <!-- Top Bar -->
            <div class="flex items-center justify-between h-16 px-6 bg-white border-b border-gray-200">
                <div class="flex items-center">
                    <!-- Mobile hamburger menu -->
                    <button class="mobile-menu-btn mr-4">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="text-xl font-semibold text-gray-800">Customers</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button class="text-gray-500 focus:outline-none">
                        <i class="fas fa-bell"></i>
                    </button>
                    <div class="relative">
                        <button class="flex items-center focus:outline-none">
                            <img class="w-8 h-8 rounded-full" src="https://randomuser.me/api/portraits/men/32.jpg" alt="User profile">
                            <span class="ml-2 text-sm font-medium text-gray-700 hidden md:inline">John Doe</span>
                            <i class="ml-1 text-gray-500 fas fa-chevron-down text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Panel Content -->
            <div class="flex-1 overflow-auto p-6">
                <!-- Main Panel Header -->
                <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-semibold text-gray-800">Customers</h2>
                        <p class="text-sm text-gray-500">Manage and monitor customer details with warranty tracking</p>
                    </div>
                    <button id="addCustomerBtn" class="mt-4 md:mt-0 inline-flex items-center px-4 py-2 bg-gray-800 text-white text-sm font-medium rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                        <i class="fas fa-plus mr-2"></i> Add Customer
                    </button>
                </div>

                <!-- Search and Filter Bar -->
                <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                    <div class="flex flex-col md:flex-row md:items-center md:space-x-4 space-y-4 md:space-y-0">
                        <div class="flex-1">
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-search text-gray-400"></i>
                                </div>
                                <input id="searchInput" type="text" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Search customers by name, email, or phone...">
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <select id="statusFilter" class="block w-full md:w-auto pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                <option value="all">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                            <select id="productFilter" class="block w-full md:w-auto pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                <option value="all">All Products</option>
                                <option value="CRM Software">CRM Software</option>
                                <option value="Analytics Tool">Analytics Tool</option>
                                <option value="Marketing Suite">Marketing Suite</option>
                            </select>
                            <select id="warrantyFilter" class="block w-full md:w-auto pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                <option value="all">All Warranty</option>
                                <option value="with-warranty">With Warranty</option>
                                <option value="no-warranty">No Warranty</option>
                                <option value="expired">Expired</option>
                            </select>
                            <select id="sortFilter" class="block w-full md:w-auto pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                <option value="newest">Newest First</option>
                                <option value="oldest">Oldest First</option>
                                <option value="end-date">End Date</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Customer Table -->
                <div class="bg-white shadow-sm rounded-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product Interest</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start Date</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">End Date</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Warranty</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customerTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Customer rows will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="flex items-center justify-between mt-6 px-4 py-3 bg-white border-t border-gray-200 sm:px-6 rounded-b-lg">
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p id="paginationInfo" class="text-sm text-gray-700">
                                Showing <span class="font-medium">1</span> to <span class="font-medium">3</span> of <span class="font-medium">3</span> customers
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                <a href="#" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <span class="sr-only">Previous</span>
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                                <a href="#" aria-current="page" class="z-10 bg-blue-50 border-blue-500 text-blue-600 relative inline-flex items-center px-4 py-2 border text-sm font-medium">
                                    1
                                </a>
                                <a href="#" class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium">
                                    2
                                </a>
                                <a href="#" class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium">
                                    3
                                </a>
                                <a href="#" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <span class="sr-only">Next</span>
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Customer Modal -->
    <div id="customerModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="modalTitle" class="modal-title">Add Customer</h3>
                <button id="closeModalBtn" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="customerForm">
                    <input type="hidden" id="customerId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="name" class="form-label">Full Name</label>
                            <input type="text" id="name" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" id="email" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="phone" class="form-label">Phone</label>
                            <input type="tel" id="phone" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="product" class="form-label">Product Interest</label>
                            <select id="product" class="form-input" required>
                                <option value="">Select Product</option>
                                <option value="CRM Software">CRM Software</option>
                                <option value="Analytics Tool">Analytics Tool</option>
                                <option value="Marketing Suite">Marketing Suite</option>
                            </select>
                        </div>
                        <div class="form-group md:col-span-2">
                            <label for="address" class="form-label">Address</label>
                            <input type="text" id="address" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="date" id="startDate" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="endDate" class="form-label">End Date</label>
                            <input type="date" id="endDate" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Warranty Extended</label>
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="hasWarranty" class="mr-2">
                                    <label for="hasWarranty" class="text-sm">Enable Warranty</label>
                                </div>
                                <select id="warrantyYears" class="form-input" style="width: auto;" disabled>
                                    <option value="1">1 Year</option>
                                    <option value="2">2 Years</option>
                                    <option value="3">3 Years</option>
                                    <option value="4">4 Years</option>
                                    <option value="5">5 Years</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="cancelBtn" class="btn btn-secondary">Cancel</button>
                <button id="saveCustomerBtn" class="btn btn-primary">Save Customer</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content confirm-modal">
            <div class="modal-header">
                <h3 class="modal-title">Confirm Delete</h3>
                <button id="closeDeleteModalBtn" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this customer? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button id="cancelDeleteBtn" class="btn btn-secondary">Cancel</button>
                <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>

    <!-- Inject real DB data as JSON -->
<script id="customer-data" type="application/json">
    {{ customers | tojson }}
  </script>
  
    <script>
// Combined Navigation and Customer Management JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Navigation
    initNavigation();
    
    // Initialize Customer Management
    initCustomerManagement();
});

// Navigation functionality
function initNavigation() {
    const mobileMenuButton = document.querySelector('.mobile-menu-btn');
    const sidebar = document.querySelector('.sidebar-container');

    if (mobileMenuButton && sidebar) {
        // Initially hide sidebar on mobile
        sidebar.classList.add('sidebar-mobile-hidden');

        // Toggle sidebar when hamburger is clicked
        mobileMenuButton.addEventListener('click', function() {
            sidebar.classList.toggle('sidebar-mobile-hidden');
        });

        // Close sidebar when clicking outside on mobile
        sidebar.addEventListener('click', function(e) {
            if (e.target === sidebar) {
                sidebar.classList.add('sidebar-mobile-hidden');
            }
        });

        // Close sidebar on window resize if mobile
        window.addEventListener('resize', function() {
            if (window.innerWidth >= 768) {
                sidebar.classList.remove('sidebar-mobile-hidden');
            } else {
                sidebar.classList.add('sidebar-mobile-hidden');
            }
        });
    }

    // Handle active navigation link
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(function(link) {
        link.addEventListener('click', function(e) {
            // Don't prevent default for actual navigation
            // Remove active class from all links
            navLinks.forEach(function(l) {
                l.classList.remove('nav-link-active');
            });
            // Add active class to clicked link
            this.classList.add('nav-link-active');
        });
    });
}

// Customer Management functionality
function initCustomerManagement() {
    // DOM Elements
    const addCustomerBtn = document.getElementById('addCustomerBtn');
    const customerModal = document.getElementById('customerModal');
    const deleteModal = document.getElementById('deleteModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const closeDeleteModalBtn = document.getElementById('closeDeleteModalBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const saveCustomerBtn = document.getElementById('saveCustomerBtn');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const customerForm = document.getElementById('customerForm');
    const customerTableBody = document.getElementById('customerTableBody');
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const productFilter = document.getElementById('productFilter');
    const warrantyFilter = document.getElementById('warrantyFilter');
    const sortFilter = document.getElementById('sortFilter');
    const hasWarrantyCheckbox = document.getElementById('hasWarranty');
    const warrantyYearsSelect = document.getElementById('warrantyYears');
    
    // Sample data with new structure
    let customers = JSON.parse(document.getElementById("customer-data").textContent);

    
    let currentCustomerId = null;
    let isEditMode = false;
    
    // Initialize customer management
    renderCustomerTable(customers);
    setupCustomerEventListeners();
    
    // Set up event listeners
    function setupCustomerEventListeners() {
        // Modal buttons
        addCustomerBtn.addEventListener('click', openAddCustomerModal);
        closeModalBtn.addEventListener('click', closeModal);
        closeDeleteModalBtn.addEventListener('click', closeDeleteModal);
        cancelBtn.addEventListener('click', closeModal);
        cancelDeleteBtn.addEventListener('click', closeDeleteModal);
        saveCustomerBtn.addEventListener('click', saveCustomer);
        confirmDeleteBtn.addEventListener('click', confirmDelete);
        
        // Search and filter inputs
        searchInput.addEventListener('input', filterCustomers);
        statusFilter.addEventListener('change', filterCustomers);
        productFilter.addEventListener('change', filterCustomers);
        warrantyFilter.addEventListener('change', filterCustomers);
        sortFilter.addEventListener('change', filterCustomers);
        
        // Warranty checkbox
        hasWarrantyCheckbox.addEventListener('change', function() {
            warrantyYearsSelect.disabled = !this.checked;
            if (!this.checked) {
                warrantyYearsSelect.value = '1';
            }
        });
        
        // Close modal when clicking outside
        customerModal.addEventListener('click', function(e) {
            if (e.target === customerModal) {
                closeModal();
            }
        });
        
        deleteModal.addEventListener('click', function(e) {
            if (e.target === deleteModal) {
                closeDeleteModal();
            }
        });
    }
    
    // Calculate customer status based on dates and warranty
    function calculateCustomerStatus(customer) {
        const today = new Date();
        const endDate = new Date(customer.endDate);
        const warrantyEndDate = customer.hasWarranty ? 
            new Date(endDate.getTime() + (customer.warrantyYears * 365 * 24 * 60 * 60 * 1000)) : 
            endDate;
        
        return today <= warrantyEndDate ? 'active' : 'inactive';
    }
    
    // Format date for display
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            year: 'numeric' 
        });
    }
    
    // Get warranty display text
    function getWarrantyDisplay(customer) {
        if (!customer.hasWarranty) {
            return '<span class="text-gray-500">No Warranty</span>';
        }
        
        const endDate = new Date(customer.endDate);
        const warrantyEndDate = new Date(endDate.getTime() + (customer.warrantyYears * 365 * 24 * 60 * 60 * 1000));
        const today = new Date();
        
        if (today > warrantyEndDate) {
            return '<span class="text-red-600">Expired</span>';
        }
        
        return `<span class="text-green-600">${customer.warrantyYears} Year${customer.warrantyYears > 1 ? 's' : ''}</span><br>
                <span class="text-xs text-gray-500">Until ${formatDate(warrantyEndDate)}</span>`;
    }
    
    // Render customer table
    function renderCustomerTable(customersToRender) {
        customerTableBody.innerHTML = '';
        
        if (customersToRender.length === 0) {
            customerTableBody.innerHTML = `
                <tr>
                    <td colspan="9" class="px-6 py-4 text-center text-gray-500">
                        No customers found
                    </td>
                </tr>
            `;
            return;
        }
        
        customersToRender.forEach(function(customer) {
            const status = customer.status ? customer.status.toLowerCase() : calculateCustomerStatus(customer);
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 h-10 w-10">
                            <img class="h-10 w-10 rounded-full" src="${customer.avatar}" alt="">
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-900">${customer.name}</div>
                            <div class="text-sm text-gray-500">#${customer.customerId}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${customer.email}</div>
                    <div class="text-sm text-gray-500">${customer.phone}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${customer.address}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                        customer.product === 'CRM Software' ? 'bg-blue-100 text-blue-800' : 
                        customer.product === 'Analytics Tool' ? 'bg-pink-100 text-pink-800' : 
                        'bg-green-100 text-green-800'
                    }">${customer.product}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${formatDate(customer.startDate)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${formatDate(customer.endDate)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    ${getWarrantyDisplay(customer)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                        status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                    }">
                        ${status.charAt(0).toUpperCase() + status.slice(1)}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <div class="flex space-x-3">
                        <a href="#" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a href="#" class="edit-btn text-gray-400 hover:text-blue-600" data-id="${customer.id}">
                            <i class="fas fa-pencil-alt"></i>
                        </a>
                        <a href="#" class="delete-btn text-gray-400 hover:text-red-600" data-id="${customer.id}">
                            <i class="fas fa-trash-alt"></i>
                        </a>
                    </div>
                </td>
            `;
            customerTableBody.appendChild(row);
        });
        
        // Add event listeners to edit and delete buttons
        document.querySelectorAll('.edit-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const customerId = parseInt(this.getAttribute('data-id'));
                editCustomer(customerId);
            });
        });
        
        document.querySelectorAll('.delete-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const customerId = parseInt(this.getAttribute('data-id'));
                openDeleteModal(customerId);
            });
        });
        
        // Update pagination info
        updatePaginationInfo(customersToRender.length);
    }
    
    // Open add customer modal
    function openAddCustomerModal() {
        isEditMode = false;
        document.getElementById('modalTitle').textContent = 'Add Customer';
        customerForm.reset();
        
        // Set default dates
        const today = new Date();
        const nextYear = new Date(today.getFullYear() + 1, today.getMonth(), today.getDate());
        document.getElementById('startDate').value = today.toISOString().split('T')[0];
        document.getElementById('endDate').value = nextYear.toISOString().split('T')[0];
        
        // Reset warranty settings
        hasWarrantyCheckbox.checked = false;
        warrantyYearsSelect.disabled = true;
        warrantyYearsSelect.value = '1';
        
        customerModal.style.display = 'flex';
    }
    
    // Open edit customer modal
    function editCustomer(id) {
        isEditMode = true;
        const customer = customers.find(function(c) { return c.id === id; });
        if (customer) {
            currentCustomerId = id;
            document.getElementById('modalTitle').textContent = 'Edit Customer';
            document.getElementById('customerId').value = customer.id;
            document.getElementById('name').value = customer.name;
            document.getElementById('email').value = customer.email;
            document.getElementById('phone').value = customer.phone;
            document.getElementById('address').value = customer.address;
            document.getElementById('product').value = customer.product;
            document.getElementById('startDate').value = customer.startDate;
            document.getElementById('endDate').value = customer.endDate;
            document.getElementById('hasWarranty').checked = customer.hasWarranty;
            document.getElementById('warrantyYears').value = customer.warrantyYears;
            document.getElementById('warrantyYears').disabled = !customer.hasWarranty;
            customerModal.style.display = 'flex';
        }
    }
    
    // Open delete confirmation modal
    function openDeleteModal(id) {
        currentCustomerId = id;
        deleteModal.style.display = 'flex';
    }
    
    // Close modal
    function closeModal() {
        customerModal.style.display = 'none';
    }
    
    // Close delete modal
    function closeDeleteModal() {
        deleteModal.style.display = 'none';
    }
    
    function saveCustomer() {
        // Validate form
        if (!validateCustomerForm()) return;
    
        const id = isEditMode ? currentCustomerId : generateId();
        const customerId = isEditMode ?
            customers.find(c => c.id === currentCustomerId).customerId :
            `CUS-${String(customers.length + 1).padStart(3, '0')}`;
    
        const customer = {
            id: id,
            customerId: customerId,
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            address: document.getElementById('address').value,
            product: document.getElementById('product').value,
            startDate: document.getElementById('startDate').value,
            endDate: document.getElementById('endDate').value,
            hasWarranty: document.getElementById('hasWarranty').checked,
            warrantyYears: document.getElementById('hasWarranty').checked ?
                parseInt(document.getElementById('warrantyYears').value) : 0,
            avatar: isEditMode ?
                customers.find(c => c.id === currentCustomerId).avatar :
                `https://randomuser.me/api/portraits/${Math.random() > 0.5 ? 'men' : 'women'}/${Math.floor(Math.random() * 50)}.jpg`
        };
    
        const status = calculateCustomerStatus(customer);  // Set based on warranty/date
    
        // Send data to Flask
        fetch('/save_customer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                id: customer.id,
                name: customer.name,
                email: customer.email,
                phone: customer.phone,
                address: customer.address,
                product: customer.product,
                status: status,
                startDate: customer.startDate,
                endDate: customer.endDate,
                warrantyYears: customer.warrantyYears,
                avatar: customer.avatar,
                isEditMode: isEditMode
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update local UI copy
                customer.status = status;
    
                if (isEditMode) {
                    customers = customers.map(c => c.id === currentCustomerId ? customer : c);
                } else {
                    customers.push(customer);
                }
    
                renderCustomerTable(customers);
                closeModal();
            } else {
                alert("Error saving customer!");
            }
        })
        .catch(error => {
            console.error("Error saving customer:", error);
            alert("Something went wrong!");
        });
    }
    
    
    // Validate the customer form
    function validateCustomerForm() {
        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        const address = document.getElementById('address').value;
        const product = document.getElementById('product').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        if (!name || !email || !phone || !address || !product || !startDate || !endDate) {
            alert('Please fill in all required fields');
            return false;
        }

        // Simple email validation
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            alert('Please enter a valid email address');
            return false;
        }

        // Date validation
        if (new Date(startDate) >= new Date(endDate)) {
            alert('End date must be after start date');
            return false;
        }

        return true;
    }
    
    // Confirm delete
    function confirmDelete() {
        // Send delete request to Flask
        fetch('/delete_customer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: currentCustomerId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove from local data and re-render table
                customers = customers.filter(function(c) { return c.id !== currentCustomerId; });
                renderCustomerTable(customers);
                closeDeleteModal();
            } else {
                alert('Failed to delete customer: ' + data.error);
            }
        })
        .catch(error => {
            console.error("Error deleting customer:", error);
            alert("Something went wrong while deleting!");
        });
    }
    
    
    // Filter customers based on search and filters
    function filterCustomers() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusValue = statusFilter.value;
        const productValue = productFilter.value;
        const warrantyValue = warrantyFilter.value;
        const sortValue = sortFilter.value;
        
        let filteredCustomers = customers.filter(function(customer) {
            const matchesSearch = 
                customer.name.toLowerCase().includes(searchTerm) || 
                customer.email.toLowerCase().includes(searchTerm) || 
                customer.phone.includes(searchTerm);
            
            const customerStatus = calculateCustomerStatus(customer);
            const matchesStatus = 
                statusValue === 'all' || 
                customerStatus === statusValue;
            
            const matchesProduct = 
                productValue === 'all' || 
                customer.product === productValue;
            
            const matchesWarranty = 
                warrantyValue === 'all' || 
                (warrantyValue === 'with-warranty' && customer.hasWarranty && customerStatus === 'active') ||
                (warrantyValue === 'no-warranty' && !customer.hasWarranty) ||
                (warrantyValue === 'expired' && customer.hasWarranty && customerStatus === 'inactive');
            
            return matchesSearch && matchesStatus && matchesProduct && matchesWarranty;
        });
        
        // Sort customers
        if (sortValue === 'newest') {
            filteredCustomers.sort(function(a, b) { return new Date(b.startDate) - new Date(a.startDate); });
        } else if (sortValue === 'oldest') {
            filteredCustomers.sort(function(a, b) { return new Date(a.startDate) - new Date(b.startDate); });
        } else if (sortValue === 'end-date') {
            filteredCustomers.sort(function(a, b) { return new Date(a.endDate) - new Date(b.endDate); });
        }
        
        renderCustomerTable(filteredCustomers);
    }
    
    // Generate ID for new customer
    function generateId() {
        return customers.length > 0 ? Math.max.apply(Math, customers.map(function(c) { return c.id; })) + 1 : 1;
    }
    
    // Update pagination info
    function updatePaginationInfo(filteredCount) {
        const totalCount = customers.length;
        const infoElement = document.getElementById('paginationInfo');
        
        if (filteredCount === totalCount) {
            infoElement.innerHTML = `
                Showing <span class="font-medium">1</span> to <span class="font-medium">${totalCount}</span> of <span class="font-medium">${totalCount}</span> customers
            `;
        } else {
            infoElement.innerHTML = `
                Showing <span class="font-medium">1</span> to <span class="font-medium">${filteredCount}</span> of <span class="font-medium">${totalCount}</span> customers (${filteredCount} filtered)
            `;
        }
    }
}
    </script>
</body>
</html>
